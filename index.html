<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Fentanyl Care - iOS Fixed</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="fenta_logo.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-dark: #050505;
      --card-bg: rgba(20, 20, 30, 0.7);
      --neon-blue: #00f3ff;
      --neon-purple: #bc13fe;
      --neon-red: #ff003c;
      --neon-green: #0aff68;
      --text-main: #ffffff;
      --text-muted: #94a3b8;
      --glass-border: 1px solid rgba(255, 255, 255, 0.1);
      --glow: 0 0 10px rgba(0, 243, 255, 0.3);
      --radius: 16px;
    }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Sarabun', sans-serif;
      background-color: var(--bg-dark);
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(188, 19, 254, 0.15) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(0, 243, 255, 0.1) 0%, transparent 20%);
      color: var(--text-main);
      margin: 0;
      padding: 0;
      line-height: 1.5;
      min-height: 100vh;
    }

    h1, h2, h3, .brand-text h1, .stat-value, .clock { font-family: 'Orbitron', sans-serif; letter-spacing: 1px; }

    header {
      background: rgba(5, 5, 5, 0.8);
      backdrop-filter: blur(10px);
      padding: 15px 20px;
      border-bottom: var(--glass-border);
      position: sticky; top: 0; z-index: 100;
      display: flex; justify-content: space-between; align-items: center;
    }

    .brand { display: flex; align-items: center; gap: 12px; }
    .brand img { height: 40px; width: auto; border-radius: 6px; box-shadow: var(--glow); }
    .brand-text h1 { font-size: 16px; margin: 0; color: var(--neon-blue); text-shadow: 0 0 5px var(--neon-blue); }
    .brand-text p { font-size: 10px; margin: 0; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

    .icon-btn {
      background: rgba(255,255,255,0.05); color: var(--neon-blue); border: 1px solid var(--neon-blue);
      width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 18px; cursor: pointer; box-shadow: 0 0 5px var(--neon-blue); transition: 0.2s;
    }
    .icon-btn:active { transform: scale(0.9); box-shadow: 0 0 15px var(--neon-blue); }

    .btn {
      padding: 12px; border-radius: 8px; border: none; font-family: 'Sarabun', sans-serif;
      font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
      text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s ease; position: relative; overflow: hidden;
    }
    .btn-primary { background: transparent; border: 1px solid var(--neon-blue); color: var(--neon-blue); box-shadow: 0 0 8px rgba(0, 243, 255, 0.2); }
    .btn-primary:hover, .btn-primary:active { background: var(--neon-blue); color: #000; box-shadow: 0 0 20px var(--neon-blue); }
    .btn-danger { background: transparent; border: 1px solid var(--neon-red); color: var(--neon-red); }
    .btn-danger:active { background: var(--neon-red); color: #fff; box-shadow: 0 0 15px var(--neon-red); }
    .btn-guide { background: linear-gradient(90deg, var(--neon-purple), #8a2be2); color: white; border: none; width: 100%; margin-top: 20px; box-shadow: 0 0 10px var(--neon-purple); }

    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .dashboard-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
    .stat-card { background: var(--card-bg); border: var(--glass-border); padding: 15px; border-radius: var(--radius); text-align: center; position: relative; overflow: hidden; }
    .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, var(--neon-blue), transparent); }
    .stat-value { font-size: 28px; font-weight: 700; color: var(--text-main); text-shadow: 0 0 10px rgba(255,255,255,0.3); }
    .stat-label { font-size: 12px; color: var(--text-muted); margin-top: 5px; }

    .audio-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .form-card { background: var(--card-bg); border: var(--glass-border); border-radius: var(--radius); padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .section-title { font-size: 14px; color: var(--neon-blue); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; display: flex; justify-content: space-between; }
    .input-group { margin-bottom: 16px; }
    .input-label { display: block; margin-bottom: 8px; font-size: 13px; color: var(--text-muted); }
    .form-control { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid #333; border-radius: 8px; color: white; font-family: 'Sarabun'; font-size: 16px; transition: 0.3s; }
    .form-control:focus { outline: none; border-color: var(--neon-blue); box-shadow: 0 0 10px rgba(0, 243, 255, 0.1); }
    select.form-control { -webkit-appearance: none; }

    .med-card { background: var(--card-bg); border: var(--glass-border); border-radius: var(--radius); padding: 16px; margin-bottom: 16px; border-left: 3px solid var(--text-muted); transition: 0.3s; }
    .med-card.active { border-left-color: var(--neon-green); box-shadow: 0 0 15px rgba(10, 255, 104, 0.05); }
    .med-card.overdue { border-left-color: var(--neon-red); box-shadow: 0 0 15px rgba(255, 0, 60, 0.1); border-color: rgba(255,0,60,0.3); }
    .med-name { font-size: 18px; font-weight: 600; color: white; }
    .med-time { font-family: 'Orbitron'; font-size: 20px; color: var(--neon-blue); margin: 8px 0; }
    .status-text { font-size: 12px; color: var(--text-muted); text-transform: uppercase; float: right; }

    /* Guide & Modal */
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 2000; display: none; opacity: 0; transition: opacity 0.3s ease; align-items: center; justify-content: center; padding: 20px; }
    .modal.show { display: flex; opacity: 1; }
    .modal-content { background: #1a1a24; border: 1px solid var(--neon-blue); box-shadow: 0 0 30px rgba(0, 243, 255, 0.15); width: 100%; max-width: 500px; max-height: 85vh; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { padding: 20px; background: linear-gradient(90deg, rgba(0, 243, 255, 0.1), transparent); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-family: 'Sarabun'; font-weight: 700; font-size: 20px; color: var(--neon-blue); }
    .close-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
    .modal-body { padding: 20px; overflow-y: auto; color: #e2e8f0; font-size: 15px; line-height: 1.6; }
    .guide-section { margin-bottom: 20px; }
    .guide-head { color: var(--neon-blue); font-weight: 700; font-size: 16px; margin-bottom: 8px; }
    .guide-list { list-style: none; padding: 0; margin: 0; }
    .guide-list li { position: relative; padding-left: 15px; margin-bottom: 6px; color: #cbd5e1; }
    .guide-list li::before { content: '‚Ä¢'; position: absolute; left: 0; color: var(--text-muted); }
    .text-red { color: var(--neon-red); font-weight: 700; text-shadow: 0 0 5px rgba(255, 0, 60, 0.5); }
    .text-bold { font-weight: 700; color: white; }

    footer { text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 14px; border-top: 1px solid rgba(255,255,255,0.05); margin-top: 40px; }
    .dev-credit { color: var(--neon-blue); font-weight: 500; }
    .counter { margin-top: 15px; opacity: 0.7; transition: opacity 0.3s; }
    .counter:hover { opacity: 1; }
    .counter img { border-radius: 4px; }

    .toast { position: fixed; bottom: 20px; left: 20px; right: 20px; background: rgba(15, 23, 42, 0.95); border: 1px solid var(--neon-blue); color: white; padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 12px; transform: translateY(150%); transition: 0.3s; z-index: 3000; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); }
    .toast.show { transform: translateY(0); }
    .toast-warning { border-color: var(--neon-red); box-shadow: 0 0 10px rgba(255, 0, 60, 0.3); }

    /* iOS Warning Banner */
    #iosBanner {
        display: none;
        background: rgba(255, 165, 0, 0.15);
        border: 1px solid orange;
        color: #fbbf24;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
        font-size: 14px;
        line-height: 1.6;
        text-align: left;
    }
  </style>
</head>
<body>

  <header>
    <div class="brand">
      <img src="fenta_logo.png" alt="Logo" onerror="this.style.display='none'">
      <div class="brand-text">
        <h1>Fentanyl Care</h1>
        <p>High Alert Medication</p>
      </div>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="icon-btn" onclick="requestNotification()" title="‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô">üîî</button>
        <button class="icon-btn" onclick="openGuide()" title="‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠">üìñ</button>
        <button class="icon-btn" style="border-color:var(--neon-red); color:var(--neon-red);" onclick="clearAllData()" title="‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">üóëÔ∏è</button>
    </div>
  </header>

  <div class="container">
    
    <div id="iosBanner">
        <b>üì± ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ iPhone:</b><br>
        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏î‡πâ ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Safari ‡∏õ‡∏Å‡∏ï‡∏¥<br>
        <br>
        1. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ä‡∏£‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á (‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏®‡∏£)<br>
        2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b>"‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÇ‡∏Æ‡∏°" (Add to Home Screen)</b><br>
        3. ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏≠‡∏õ‡πÉ‡∏´‡∏°‡πà
    </div>

    <div class="audio-controls">
        <button class="btn btn-primary" onclick="testAlarm()">üîä ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
        <button class="btn btn-danger" onclick="stopAlarm()">üîá ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
    </div>

    <div class="dashboard-row">
      <div class="stat-card">
        <div class="stat-value" id="activeCount">0</div>
        <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="dueSoonCount" style="color: var(--neon-red);">0</div>
        <div class="stat-label">‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</div>
      </div>
    </div>

    <div class="form-card">
      <div class="section-title">
        <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</span>
        <span class="clock" id="clock">00:00</span>
      </div>
      
      <form id="medForm">
        <input type="hidden" id="medId">
        <div class="input-group">
            <label class="input-label">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤</label>
            <input type="text" id="medName" class="form-control" value="Fentanyl Patch" required>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="input-group">
                <label class="input-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</label>
                <select id="interval" class="form-control">
                    <option value="72" selected>72 ‡∏ä‡∏°. (3 ‡∏ß‡∏±‡∏ô)</option>
                    <option value="48">48 ‡∏ä‡∏°. (2 ‡∏ß‡∏±‡∏ô)</option>
                    <option value="24">24 ‡∏ä‡∏°. (1 ‡∏ß‡∏±‡∏ô)</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÅ‡∏ú‡πà‡∏ô)</label>
                <input type="number" id="qty" class="form-control" value="1" min="1">
            </div>
        </div>
        <div class="input-group">
            <label class="input-label">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏õ‡∏∞</label>
            <input type="datetime-local" id="startAt" class="form-control">
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="submit" class="btn btn-primary" style="flex:1;" id="submitBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button type="button" class="btn btn-danger" style="flex:0.4;" onclick="resetForm()" id="cancelBtn">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
        </div>
      </form>
    </div>

    <button class="btn btn-guide" onclick="openGuide()">üìñ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Manual)</button>

    <br>

    <div class="section-title" style="margin-top: 20px;">
      <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</span>
    </div>
    <div id="listWrap"></div>

  </div> <footer>
    <p>‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ <b class="dev-credit">‡∏û‡∏ß.‡∏ß‡∏¥‡∏©‡∏ì‡∏∏‡∏Å‡∏£‡∏ì‡πå ‡πÇ‡∏≠‡∏¢‡∏≤ (‡∏£‡∏û.‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ)</b></p>
    <br>‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà .... ‡∏Å‡∏£‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏õ‡∏±‡∏ç‡∏ç‡∏≤</br>
    <div class="counter">
      <a href="https://www.freecounterstat.com" title="free hit counter">
        <img src="https://counter1.optistats.ovh/private/freecounterstat.php?c=nkgarzzb5qbwy6cck5wpqdc4qq5ks6e4" border="0" title="free hit counter" alt="free hit counter">
      </a>
    </div>
  </footer>

  <div id="guideModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <div class="modal-title">üìñ ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ Fentanyl Patch</div>
              <button class="close-btn" onclick="closeGuide()">√ó</button>
          </div>
          <div class="modal-body">
              <div style="text-align: center; margin-bottom: 20px;">
                  <a href="handbook_fenta.png" target="_blank" style="text-decoration: none; width: 100%;">
                      <button class="btn btn-primary" style="width: 100%; justify-content: center; box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);">
                          üñºÔ∏è ‡∏î‡∏π‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏â‡∏ö‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Infographic)
                      </button>
                  </a>
              </div>
              <hr style="border-color: rgba(255,255,255,0.1); margin-bottom: 20px;">
              <div class="guide-section">
                  <div class="guide-head">1) ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
                  <ul class="guide-list">
                      <li><span class="text-bold">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°:</span> ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏ô, ‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏ô, ‡∏ä‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á, ‡∏ï‡πâ‡∏ô‡πÅ‡∏Ç‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å</li>
                      <li><span class="text-bold">‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á:</span> ‡πÅ‡∏ú‡∏•, ‡∏ú‡∏∑‡πà‡∏ô, ‡∏Ç‡πâ‡∏≠‡∏û‡∏±‡∏ö, ‡∏ú‡∏¥‡∏ß‡∏°‡∏±‡∏ô/‡∏ó‡∏≤‡∏Ñ‡∏£‡∏µ‡∏°</li>
                      <li><span class="text-bold">‡∏Ç‡∏ô:</span> ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏£‡πÑ‡∏Å‡∏£‡πÄ‡∏•‡πá‡∏°‡∏™‡∏±‡πâ‡∏ô <span class="text-red">‡∏´‡πâ‡∏≤‡∏°‡πÇ‡∏Å‡∏ô</span> (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏Ñ‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏∑‡∏≠‡∏á/‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡∏¢‡∏≤‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)</li>
                  </ul>
              </div>
              <div class="guide-section">
                  <div class="guide-head">2) ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏ã‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏Å‡πÅ‡∏ú‡πà‡∏ô</div>
                  <ul class="guide-list">
                      <li>‡πÅ‡∏Å‡∏∞‡∏ã‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤ (‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏£‡∏£‡πÑ‡∏Å‡∏£‡πÇ‡∏î‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏¢‡∏≤)</li>
                      <li>‡∏•‡∏≠‡∏Å‡∏ü‡∏¥‡∏•‡πå‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡∏ù‡∏±‡πà‡∏á ‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏ß</li>
                  </ul>
              </div>
              <div class="guide-section">
                  <div class="guide-head">3) ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡πÅ‡∏ú‡πà‡∏ô‡∏¢‡∏≤</div>
                  <ul class="guide-list">
                      <li>‡πÅ‡∏õ‡∏∞‡∏•‡∏á‡∏ö‡∏ô‡∏ú‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ</li>
                      <li><span class="text-bold">‡πÉ‡∏ä‡πâ‡∏ù‡πà‡∏≤‡∏°‡∏∑‡∏≠‡∏Å‡∏î‡πÅ‡∏ô‡πà‡∏ô‡πÜ 20-30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</span> ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏ö‡∏™‡∏ô‡∏¥‡∏ó</li>
                      <li>‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏ö‡∏π‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
                  </ul>
              </div>
              <div class="guide-section">
                  <div class="guide-head" style="color: var(--neon-red);">4) ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á (Strictly)</div>
                  <ul class="guide-list">
                      <li><span class="text-red">‡∏´‡πâ‡∏≤‡∏°‡πÇ‡∏î‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô</span> (‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô/‡∏õ‡∏£‡∏∞‡∏Ñ‡∏ö) ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏¢‡∏≤‡∏à‡∏∞‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (Overdose)</li>
                      <li>‡∏´‡∏≤‡∏Å‡πÅ‡∏ú‡πà‡∏ô‡∏•‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏õ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ï‡∏¥‡∏î‡∏ó‡∏±‡∏ö (‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏û‡∏•‡∏≤‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤)</li>
                      <li><span class="text-bold">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å 72 ‡∏ä‡∏°. (3 ‡∏ß‡∏±‡∏ô)</span> ‡πÅ‡∏•‡∏∞‡∏ß‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡πÄ‡∏î‡∏¥‡∏°</li>
                      <li>‡πÅ‡∏ú‡πà‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏ö‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏¥‡πâ‡∏á</li>
                  </ul>
              </div>
          </div>
          <div style="padding: 15px; text-align: center; border-top: 1px solid rgba(255,255,255,0.1);">
              <button class="btn btn-primary" style="width: 100%;" onclick="closeGuide()">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
          </div>
      </div>
  </div>

  <div id="toast" class="toast">
    <span id="toastIcon" style="font-size: 24px;">üì¢</span>
    <span id="toastMessage">Message</span>
  </div>

  <script>
    const DB_KEY = 'fenta_ios_fixed_v16';
    let items = [];
    let audioCtx = null;
    let isAudioUnlocked = false;

    window.addEventListener('DOMContentLoaded', () => {
        checkIOSStandalone(); // Check iOS Mode immediately
        const now = new Date();
        const localISO = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        document.getElementById('startAt').value = localISO;
        loadData();
        updateClock();
        setInterval(updateClock, 1000);
        setInterval(checkDueMedications, 5000);
    });

    // --- iOS Check Logic ---
    function checkIOSStandalone() {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
        
        if (isIOS && !isStandalone) {
            document.getElementById('iosBanner').style.display = 'block';
        }
    }

    // --- Audio Logic ---
    function unlockAudio() {
        if (isAudioUnlocked) return;
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const buffer = audioCtx.createBuffer(1, 1, 22050);
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(audioCtx.destination);
        source.start(0);
        isAudioUnlocked = true;
        document.removeEventListener('click', unlockAudio);
        document.removeEventListener('touchstart', unlockAudio);
    }
    document.addEventListener('click', unlockAudio);
    document.addEventListener('touchstart', unlockAudio);

    function beep(freq, duration, type, startTime) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(startTime);
        gain.gain.setValueAtTime(0.5, startTime);
        gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
        osc.stop(startTime + duration);
    }

    function playAlarm() {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const now = audioCtx.currentTime;
        for(let i=0; i<15; i++) { 
            beep(880, 0.1, 'square', now + (i * 0.8));
            beep(550, 0.1, 'square', now + (i * 0.8) + 0.15);
        }
    }

    function stopAlarm() {
        if(audioCtx && audioCtx.state === 'running') {
            audioCtx.suspend().then(() => { setTimeout(() => { if(audioCtx) audioCtx.resume(); }, 1000); });
        }
    }

    function testAlarm() {
        unlockAudio();
        setTimeout(() => { playAlarm(); showToast('üîä ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á', 'info'); }, 100);
    }
    
    function requestNotification() {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;

        if (isIOS && !isStandalone) {
             alert("‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÇ‡∏Æ‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏ô iPhone ‡πÑ‡∏î‡πâ");
             return;
        }

        if (!("Notification" in window)) {
            showToast('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö', 'warning');
        } else if (Notification.permission === "granted") {
            showToast('‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß', 'info');
        } else if (Notification.permission !== "denied") {
            Notification.requestPermission().then(function (permission) {
                if (permission === "granted") {
                    showToast('‚úÖ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    new Notification("Fentanyl Care", { body: "‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö", icon: "fenta_logo.png" });
                }
            });
        }
    }

    // --- Core UI Logic ---
    function openGuide() { document.getElementById('guideModal').classList.add('show'); }
    function closeGuide() { document.getElementById('guideModal').classList.remove('show'); }
    function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}); }
    
    function loadData() { try { items = JSON.parse(localStorage.getItem(DB_KEY) || '[]'); } catch { items = []; } render(); }
    function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(items)); render(); }
    
    function getNextDoseTime(startISO, hours) {
        const start = new Date(startISO);
        const intervalMs = hours * 3600000;
        let next = new Date(start.getTime() + intervalMs);
        const now = new Date();
        while(next < now) { next = new Date(next.getTime() + intervalMs); }
        return next.toISOString();
    }

    function getTimeRemaining(nextTime) {
        const diff = new Date(nextTime) - new Date();
        const hours = Math.floor(diff / 3600000);
        const mins = Math.floor((diff % 3600000) / 60000);
        if (diff <= 0) return { overdue: true, text: '‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', hours: 0 };
        let text = hours >= 24 ? `‡∏≠‡∏µ‡∏Å ${Math.floor(hours/24)} ‡∏ß‡∏±‡∏ô ${hours%24} ‡∏ä‡∏°.` : `‡∏≠‡∏µ‡∏Å ${hours} ‡∏ä‡∏°. ${mins} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        return { overdue: false, text, hours };
    }

    document.getElementById('medForm').addEventListener('submit', (e) => {
        e.preventDefault();
        unlockAudio();
        const name = document.getElementById('medName').value;
        const hours = parseInt(document.getElementById('interval').value);
        const qty = parseInt(document.getElementById('qty').value);
        const start = new Date(document.getElementById('startAt').value).toISOString();
        const newItem = { id: Date.now().toString(36), name, hours, qty, start, nextAt: getNextDoseTime(start, hours), active: true };
        items.push(newItem); saveData(); document.getElementById('medForm').reset();
        const now = new Date();
        document.getElementById('startAt').value = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Auto Renew)', 'success');
    });

    function render() {
        const wrap = document.getElementById('listWrap');
        if(items.length === 0) { wrap.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted); border: 1px dashed var(--text-muted); border-radius:16px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>`; updateStats(); return; }
        items.sort((a,b) => new Date(a.nextAt) - new Date(b.nextAt));
        let html = '';
        items.forEach(item => {
            const t = getTimeRemaining(item.nextAt);
            const dateStr = new Date(item.nextAt).toLocaleDateString('th-TH', {day:'numeric', month:'short'});
            const timeStr = new Date(item.nextAt).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
            html += `<div class="med-card ${item.active ? (t.overdue ? 'overdue' : 'active') : ''}" style="${!item.active ? 'opacity:0.5' : ''}">
                <div style="display:flex; justify-content:space-between;"><span class="med-name">${item.name} <small style="color:var(--text-muted); font-size:12px;">(x${item.qty})</small></span><span class="status-text">${item.active ? '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' : '‡∏´‡∏¢‡∏∏‡∏î'}</span></div>
                <div class="med-time">${t.overdue ? '‚ö†Ô∏è' : '‚è∞'} ${dateStr} ‡πÄ‡∏ß‡∏•‡∏≤ ${timeStr}</div>
                <div style="color:${t.overdue ? 'var(--neon-red)' : 'var(--neon-blue)'}; font-size:14px; font-weight:600;">${t.text}</div>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn ${item.active ? 'btn-danger' : 'btn-primary'}" style="flex:1; height:36px;" onclick="toggle('${item.id}')">${item.active ? '‡∏´‡∏¢‡∏∏‡∏î' : '‡πÄ‡∏£‡∏¥‡πà‡∏°'}</button>
                    <button class="btn btn-danger" style="flex:0.5; height:36px;" onclick="del('${item.id}')">‡∏•‡∏ö</button>
                </div></div>`;
        });
        wrap.innerHTML = html; updateStats();
    }

    function toggle(id) { const i = items.find(x => x.id === id); if(i) { i.active = !i.active; saveData(); } }
    function del(id) { if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?')) { items = items.filter(x => x.id !== id); saveData(); } }
    function resetForm() { document.getElementById('medForm').reset(); }
    function updateStats() { document.getElementById('activeCount').innerText = items.filter(i => i.active).length; document.getElementById('dueSoonCount').innerText = items.filter(i => i.active && getTimeRemaining(i.nextAt).hours < 24).length; }
    function clearAllData() { if(confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) { items = []; saveData(); } }
    function showToast(msg, type) { const t = document.getElementById('toast'); document.getElementById('toastMessage').innerText = msg; t.className = 'toast show ' + (type==='warning'?'toast-warning':''); setTimeout(() => t.classList.remove('show'), 3000); }

    function checkDueMedications() {
        const now = new Date();
        let trigger = false;
        items.forEach(item => {
            if(item.active && new Date(item.nextAt) <= now) {
                trigger = true;
                item.nextAt = getNextDoseTime(item.nextAt, item.hours);
                if (Notification.permission === "granted") { new Notification("Fentanyl Alert!", { body: `‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ${item.name}`, icon: "fenta_logo.png" }); }
            }
        });
        if(trigger) { playAlarm(); saveData(); }
    }
  </script>
</body>
</html>
